# 4. Distributed hash table
## 4.3 Message-level cryptography
Each DHT peer has a static X25519 keypair used to encrypt messages. Message plaintexts are encrypted using key material derived from the shared secret produced by the static keys of the two parties. Because these keys are static, a compromise of a peer's private key allows an adversary retroactive decryption of any previous messages sent during the lifespan of that key. This is accepted as the DHT contains only routing information with time-limited value.

### 4.3.1 Parameters

The following variables are defined prior to encrypting the DHT message:
```
NetworkID // fixed constant, specific to the DHT
PayloadPlaintext // raw plaintext of a DHT protocol message
RemotePubKey // X25519 static public key of the receiving peer
LocalPubKey // X25519 static public key of the local peer
LocalPrivKey // X25519 static private key of the local peer
```

### 4.3.2 Per-message salt

A 16-byte `MsgSalt` field is generated for each message. This salt must meet the following requirements:

1. The (`RemotePubKey`, `LocalPubKey`, `MsgSalt`) tuple must be unique, with very high probability.
2. `MsgSalt` must be indistinguishable from random to the casual observer.
3. `MsgSalt` must not reveal any information about the payload of the message to a party that does not possess either `LocalPrivKey` or the private key corresponding to `RemotePubKey`.

In the present implementation, `MsgSalt` is generated by a CSPRNG.

### 4.3.3 Obfuscation key

The `LocalPubKey` field is obfuscated using a key derived from `NetworkID`, `MsgSalt` and `RemotePubKey`. This is done to prevent a casual observer from distinguishing any part of the transmitted DHT message from random.

```
ObfKey = HKDF(ikm=RemotePubKey, length=SYM_KEY_LEN, salt=NetworkID || MsgSalt, info="easysafe-dht-obfkey")
```

The key obfuscation is done by encrypting the `localPubKey` with the `ObfKey`:

```
ObfuscatedPubKey = SymmetricEncrypt(key=ObfKey, iv=zeros(SYM_IV_LEN), plaintext=LocalPubKey)
```

### 4.3.4 Message key
The message key is derived from a combination of the shared secret derived by the Diffie-Hellman operation of the `LocalPrivKey` with the `RemotePubKey`, with various extra salting parameters.

```
extraSalt = NetworkId || LocalPubKey || RemotePubKey || MsgSalt || ObfuscatedPubKey
dhSecret = DH(LocalPrivKey, RemotePubKey)
MsgKey = HKDF(ikm=dhSecret, length=SYM_KEY_LEN, salt=extraSalt, info="easysafe-dht-msgkey")
```

### 4.3.5 Message ciphertext
The DHT message payload is then encrypted using the derived `MsgKey`.

```
MsgCiphertext = SymmetricEncryptAEAD(key=messageKey, iv=zeros(SYM_IV_LEN), plaintext=plaintext)
```

### 4.3.6 Assembled message
The `MsgSalt`, `ObfuscatedPubKey` and `MsgCiphertext` are combined to form the completed DHT message.

```
DhtMsg = MsgSalt || ObfuscatedPubKey || MsgCiphertext
```

The `DhtMsg` is then transmitted to the remote peer.
